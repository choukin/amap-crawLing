import { AppService } from './../app.service';
import { Injectable, Logger } from '@nestjs/common';
import { Cron } from '@nestjs/schedule';
import { clollectMapList, clollectBusinessDistrict } from '../crawLing/collect';
import { dailySummary } from '../utils/api';
import * as dayjs from 'dayjs';
import { randomWait } from '../utils/index';
import { appendFileSync } from 'fs';
const nodeenv = process.env.NODE_ENV ? process.env.NODE_ENV : '';
@Injectable()
export class TaskService {
  constructor(
    private readonly logger: Logger,
    private readonly appService: AppService,
  ) {}

  /**
   * æœç´¢ä¹è¯»å…³é”®å­—
   * @param query
   */
  async handleSearchNotes(keyWord?: string) {
    //'å°çŒ¿å­¦ç»ƒæœº',
    const keyworkds = ['']; //['ä½œä¸šå¸®', 'ç§‘å¤§è®¯é£ž', 'å°åº¦å…¨å±‹æ™ºèƒ½'];
    // åŒ—äº¬ã€ä¸Šæµ·ã€å¹¿å·žã€æ·±åœ³ã€æˆéƒ½ã€æ­å·žã€å—äº¬ã€æ­¦æ±‰ã€å¤©æ´¥ã€è¥¿å®‰ã€é‡åº†ã€é’å²›ã€æ²ˆé˜³ã€é•¿æ²™ã€å¤§è¿žã€
    const oneLine = 'åŽ¦é—¨ã€æ— é”¡ã€ç¦å·žã€æµŽå—'.split('ã€').map((item) => {
      return { name: item, type: 'oneLine' };
    });
    const twoLine =
      'å®æ³¢ã€æ˜†æ˜Žã€è‹å·žã€éƒ‘å·žã€é•¿æ˜¥ã€åˆè‚¥ã€å—æ˜Œã€å“ˆå°”æ»¨ã€å¸¸å·žã€çƒŸå°ã€å—å®ã€æ¸©å·žã€çŸ³å®¶åº„ã€å¤ªåŽŸã€ç æµ·ã€å—é€šã€æ‰¬å·žã€è´µé˜³ã€ä¸œèŽžã€å¾å·žã€å¤§åº†ã€ä½›å±±ã€å¨æµ·ã€æ´›é˜³ã€æ·®å®‰ã€å‘¼å’Œæµ©ç‰¹ã€é•‡æ±Ÿã€æ½åŠã€æ¡‚æž—ã€ä¸­å±±ã€ä¸´æ²‚ã€å’¸é˜³ã€åŒ…å¤´ã€å˜‰å…´ã€æƒ å·žã€æ³‰å·ž'
        .split('ã€')
        .map((item) => {
          return { name: item, type: 'twoLine' };
        });
    // å®œå…´å¸‚ã€
    const threeLine =
      'ä¸‰äºšã€èµ£å·žã€ä¹æ±Ÿã€é‡‘åŽã€æ³°å®‰ã€æ¦†æž—ã€è®¸æ˜Œã€æ–°ä¹¡ã€èˆŸå±±ã€æ…ˆæºªã€å—é˜³ã€èŠåŸŽã€æµ·å£ã€ä¸œè¥ã€æ·„åšã€æ¼³å·žã€ä¿å®šã€æ²§å·žã€ä¸¹ä¸œã€ç»å…´ã€å”å±±ã€æ¹–å·žã€æ­é˜³ã€æ±Ÿé˜´ã€è¥å£ã€è¡¡é˜³ã€éƒ´å·žã€é„‚å°”å¤šæ–¯ã€æ³°å·žã€ä¹‰ä¹Œã€æ±•å¤´ã€å®œæ˜Œã€å¤§åŒã€éžå±±ã€æ¹˜æ½­ã€ç›åŸŽã€é©¬éžå±±ã€è¥„æ¨Šã€é•¿æ²»ã€æ—¥ç…§ã€å¸¸ç†Ÿã€å®‰åº†ã€å‰æž—å¸‚ã€ä¹Œé²æœ¨é½ã€å…°å·žã€ç§¦çš‡å²›ã€è‚‡åº†ã€è¥¿å®ã€ä»‹ä¼‘ã€æ»¨å·žã€å°å·žã€å»ŠåŠã€é‚¢å°ã€æ ªæ´²ã€å¾·é˜³ã€ç»µé˜³ã€åŒæµã€å¹³é¡¶å±±ã€é¾™å²©ã€é“¶å·ã€èŠœæ¹–ã€æ™‹æ±Ÿã€è¿žäº‘æ¸¯ã€å¼ å®¶æ¸¯ã€é”¦å·žã€å²³é˜³ã€é•¿æ²™åŽ¿ã€æµŽå®ã€é‚¯éƒ¸ã€æ±Ÿé—¨ã€é½é½å“ˆå°”ã€æ˜†å±±ã€æŸ³å·žã€ç»å…´åŽ¿ã€è¿åŸŽã€é½æ²³'
        .split('ã€')
        .map((item) => {
          return { name: item, type: 'threeLine' };
        });
    // å®œå…´å¸‚ã€

    const fourLine =
      'å¼ å®¶å£ã€æ¹›æ±Ÿã€çœ‰å±±ã€å¸¸å¾·ã€ç›˜é”¦ã€æž£åº„ã€èµ„é˜³ã€å®œå®¾ã€èµ¤å³°ã€ä½™å§šã€æ¸…è¿œã€èšŒåŸ ã€å®å¾·ã€å¾·å·žã€å®é¸¡ã€ç‰¡ä¸¹æ±Ÿã€é˜œé˜³ã€èŽ†ç”°ã€è¯¸æš¨ã€é»„çŸ³ã€å‰å®‰ã€å»¶å®‰ã€æ‹‰è¨ã€æµ·å®ã€é€šè¾½ã€é»„å±±ã€é•¿ä¹ã€å®‰é˜³ã€å¢žåŸŽã€æ¡ä¹¡ã€ä¸Šè™žã€è¾½é˜³ã€éµä¹‰ã€éŸ¶å…³ã€æ³¸å·žã€å—å¹³ã€æ»å·žã€æ¸©å²­ã€å—å……ã€æ™¯å¾·é•‡ã€æŠšé¡ºã€ä¹Œæµ·ã€è†é—¨ã€é˜³æ±Ÿã€æ›²é–ã€é‚µé˜³ã€å®¿è¿ã€è†å·žã€ç„¦ä½œã€ä¸¹é˜³ã€ä¸½æ°´ã€å»¶å‰ã€å»¶è¾¹æœé²œæ—è‡ªæ²»å·žã€èŒ‚åã€æ¢…å·žã€æ¸­å—ã€è‘«èŠ¦å²›ã€å¨„åº•ã€æ»•å·žã€ä¸Šé¥¶ã€å¯Œé˜³ã€å†…æ±Ÿã€ä¸‰æ˜Žã€æ·®å—ã€å­æ„Ÿã€æº§é˜³ã€ä¹å±±ã€ä¸´æ±¾ã€æ”€æžèŠ±ã€é˜³æ³‰ã€é•¿è‘›'
        .split('ã€')
        .map((item) => {
          return { name: item, type: 'fourLine' };
        });
    const fiveLine =
      'æ™‹åŸŽã€è‡ªè´¡ã€ä¸‰é—¨å³¡ã€èµ¤å³°ã€æœ¬æºªã€é˜²åŸŽæ¸¯ã€é“å²­ã€éšå·žã€å¹¿å®‰ã€å¹¿å…ƒã€å¤©æ°´ã€é‚å®ã€èä¹¡ã€è¥¿åŒç‰ˆçº³ã€ç»¥åŒ–ã€é¹¤å£ã€æ¹˜è¥¿ã€æ¾åŽŸã€é˜œæ–°ã€é…’æ³‰ã€å¼ å®¶ç•Œã€é»”è¥¿å—ã€ä¿å±±ã€æ˜­é€šã€æ²³æ± ã€æ¥å®¾ã€çŽ‰æºªã€æ¢§å·žã€é¹°æ½­ã€é’¦å·žã€äº‘æµ®ã€ä½³æœ¨æ–¯ã€å…‹æ‹‰çŽ›ä¾ã€å‘¼ä¼¦è´å°”ã€è´ºå·žã€é€šåŒ–ã€é˜³æ³‰ã€æœé˜³ã€ç™¾è‰²ã€æ¯•èŠ‚ã€è´µæ¸¯ã€ä¸½æ±Ÿã€å®‰åº·ã€é€šè¾½ã€å¾·å®ã€æœ”å·žã€ä¼ŠçŠã€æ–‡å±±ã€æ¥šé›„ã€å˜‰å³ªå…³ã€å‡‰å±±ã€èµ„é˜³ã€é”¡æž—éƒ­å‹’ç›Ÿã€é›…å®‰'
        .split('ã€')
        .map((item) => {
          return { name: item, type: 'fiveLine' };
        });

    const cities = [].concat(oneLine, twoLine, threeLine, fourLine, fiveLine);
    // const cities = [].concat(fiveLine);

    const addresses = [];
    for (let i = 0; i < keyworkds.length; i++) {
      for (let j = 0; j < cities.length; j++) {
        const keyword = keyworkds[i];
        console.log(
          `${i + 1}/${keyworkds.length}  ðŸš€ ~ keyword: ${keyword} ðŸš€ ~ city${
            j + 1
          }/${cities.length}:    ${cities[j].name}`,
        );

        const city = cities[j];
        // const keywordstr = `${keyword} ${city.name}`;
        const targetHost = `https://www.amap.com`;
        const items = (await clollectMapList(
          targetHost,
          keyword,
          city.name,
        )) as any;
        try {
          let prefix = '';
          if (j !== 0) {
            prefix = ',';
          } else {
            appendFileSync(`${keyword}.json`, '[');
          }
          appendFileSync(
            `${keyword}.json`,
            prefix + JSON.stringify({ items, keyword, city }),
          );

          if (j + 1 === cities.length) {
            appendFileSync(`${keyword}.json`, ']');
          }
        } catch (error) {
          console.error('ä¿å­˜å¤±è´¥');
        }
      }
    }

    // é€šçŸ¥çŸ¥éŸ³æ¥¼å¼€å§‹çˆ¬å–æ•°æ®
    try {
      // æŽ’é™¤å¹¿å‘Š éžç¬”è®°ç±»åž‹æ•°æ®
    } catch (error) {
      console.error(error);
    }
    return 'èŽ·å–å°çº¢ä¹¦æœç´¢æ•°æ®ç»“æŸ';
  }

  async handleSearchtBusinessDistrict(keyWord?: string) {
    //'å°çŒ¿å­¦ç»ƒæœº',
    const keyworkds = ['å•†åœˆ']; //['ä½œä¸šå¸®', 'ç§‘å¤§è®¯é£ž', 'å°åº¦å…¨å±‹æ™ºèƒ½'];
    // åŒ—äº¬ã€ä¸Šæµ·ã€å¹¿å·žã€æ·±åœ³ã€æˆéƒ½ã€æ­å·žã€å—äº¬ã€æ­¦æ±‰ã€å¤©æ´¥ã€è¥¿å®‰ã€é‡åº†ã€é’å²›ã€æ²ˆé˜³ã€é•¿æ²™ã€å¤§è¿žã€
    const oneLine =
      'åŒ—äº¬ã€ä¸Šæµ·ã€å¹¿å·žã€æ·±åœ³ã€æˆéƒ½ã€æ­å·žã€å—äº¬ã€æ­¦æ±‰ã€å¤©æ´¥ã€è¥¿å®‰ã€é‡åº†ã€é’å²›ã€æ²ˆé˜³ã€é•¿æ²™ã€å¤§è¿žã€åŽ¦é—¨ã€æ— é”¡ã€ç¦å·žã€æµŽå—'
        .split('ã€')
        .map((item) => {
          return { name: item, type: 'oneLine' };
        });
    const twoLine =
      'å®æ³¢ã€æ˜†æ˜Žã€è‹å·žã€éƒ‘å·žã€é•¿æ˜¥ã€åˆè‚¥ã€å—æ˜Œã€å“ˆå°”æ»¨ã€å¸¸å·žã€çƒŸå°ã€å—å®ã€æ¸©å·žã€çŸ³å®¶åº„ã€å¤ªåŽŸã€ç æµ·ã€å—é€šã€æ‰¬å·žã€è´µé˜³ã€ä¸œèŽžã€å¾å·žã€å¤§åº†ã€ä½›å±±ã€å¨æµ·ã€æ´›é˜³ã€æ·®å®‰ã€å‘¼å’Œæµ©ç‰¹ã€é•‡æ±Ÿã€æ½åŠã€æ¡‚æž—ã€ä¸­å±±ã€ä¸´æ²‚ã€å’¸é˜³ã€åŒ…å¤´ã€å˜‰å…´ã€æƒ å·žã€æ³‰å·ž'
        .split('ã€')
        .map((item) => {
          return { name: item, type: 'twoLine' };
        });
    // å®œå…´å¸‚ã€
    const threeLine =
      'ä¸‰äºšã€èµ£å·žã€ä¹æ±Ÿã€é‡‘åŽã€æ³°å®‰ã€æ¦†æž—ã€è®¸æ˜Œã€æ–°ä¹¡ã€èˆŸå±±ã€æ…ˆæºªã€å—é˜³ã€èŠåŸŽã€æµ·å£ã€ä¸œè¥ã€æ·„åšã€æ¼³å·žã€ä¿å®šã€æ²§å·žã€ä¸¹ä¸œã€ç»å…´ã€å”å±±ã€æ¹–å·žã€æ­é˜³ã€æ±Ÿé˜´ã€è¥å£ã€è¡¡é˜³ã€éƒ´å·žã€é„‚å°”å¤šæ–¯ã€æ³°å·žã€ä¹‰ä¹Œã€æ±•å¤´ã€å®œæ˜Œã€å¤§åŒã€éžå±±ã€æ¹˜æ½­ã€ç›åŸŽã€é©¬éžå±±ã€è¥„æ¨Šã€é•¿æ²»ã€æ—¥ç…§ã€å¸¸ç†Ÿã€å®‰åº†ã€å‰æž—å¸‚ã€ä¹Œé²æœ¨é½ã€å…°å·žã€ç§¦çš‡å²›ã€è‚‡åº†ã€è¥¿å®ã€ä»‹ä¼‘ã€æ»¨å·žã€å°å·žã€å»ŠåŠã€é‚¢å°ã€æ ªæ´²ã€å¾·é˜³ã€ç»µé˜³ã€åŒæµã€å¹³é¡¶å±±ã€é¾™å²©ã€é“¶å·ã€èŠœæ¹–ã€æ™‹æ±Ÿã€è¿žäº‘æ¸¯ã€å¼ å®¶æ¸¯ã€é”¦å·žã€å²³é˜³ã€é•¿æ²™åŽ¿ã€æµŽå®ã€é‚¯éƒ¸ã€æ±Ÿé—¨ã€é½é½å“ˆå°”ã€æ˜†å±±ã€æŸ³å·žã€ç»å…´åŽ¿ã€è¿åŸŽã€é½æ²³'
        .split('ã€')
        .map((item) => {
          return { name: item, type: 'threeLine' };
        });
    // å®œå…´å¸‚ã€

    const fourLine =
      'å¼ å®¶å£ã€æ¹›æ±Ÿã€çœ‰å±±ã€å¸¸å¾·ã€ç›˜é”¦ã€æž£åº„ã€èµ„é˜³ã€å®œå®¾ã€èµ¤å³°ã€ä½™å§šã€æ¸…è¿œã€èšŒåŸ ã€å®å¾·ã€å¾·å·žã€å®é¸¡ã€ç‰¡ä¸¹æ±Ÿã€é˜œé˜³ã€èŽ†ç”°ã€è¯¸æš¨ã€é»„çŸ³ã€å‰å®‰ã€å»¶å®‰ã€æ‹‰è¨ã€æµ·å®ã€é€šè¾½ã€é»„å±±ã€é•¿ä¹ã€å®‰é˜³ã€å¢žåŸŽã€æ¡ä¹¡ã€ä¸Šè™žã€è¾½é˜³ã€éµä¹‰ã€éŸ¶å…³ã€æ³¸å·žã€å—å¹³ã€æ»å·žã€æ¸©å²­ã€å—å……ã€æ™¯å¾·é•‡ã€æŠšé¡ºã€ä¹Œæµ·ã€è†é—¨ã€é˜³æ±Ÿã€æ›²é–ã€é‚µé˜³ã€å®¿è¿ã€è†å·žã€ç„¦ä½œã€ä¸¹é˜³ã€ä¸½æ°´ã€å»¶å‰ã€å»¶è¾¹æœé²œæ—è‡ªæ²»å·žã€èŒ‚åã€æ¢…å·žã€æ¸­å—ã€è‘«èŠ¦å²›ã€å¨„åº•ã€æ»•å·žã€ä¸Šé¥¶ã€å¯Œé˜³ã€å†…æ±Ÿã€ä¸‰æ˜Žã€æ·®å—ã€å­æ„Ÿã€æº§é˜³ã€ä¹å±±ã€ä¸´æ±¾ã€æ”€æžèŠ±ã€é˜³æ³‰ã€é•¿è‘›'
        .split('ã€')
        .map((item) => {
          return { name: item, type: 'fourLine' };
        });
    const fiveLine =
      'æ™‹åŸŽã€è‡ªè´¡ã€ä¸‰é—¨å³¡ã€èµ¤å³°ã€æœ¬æºªã€é˜²åŸŽæ¸¯ã€é“å²­ã€éšå·žã€å¹¿å®‰ã€å¹¿å…ƒã€å¤©æ°´ã€é‚å®ã€èä¹¡ã€è¥¿åŒç‰ˆçº³ã€ç»¥åŒ–ã€é¹¤å£ã€æ¹˜è¥¿ã€æ¾åŽŸã€é˜œæ–°ã€é…’æ³‰ã€å¼ å®¶ç•Œã€é»”è¥¿å—ã€ä¿å±±ã€æ˜­é€šã€æ²³æ± ã€æ¥å®¾ã€çŽ‰æºªã€æ¢§å·žã€é¹°æ½­ã€é’¦å·žã€äº‘æµ®ã€ä½³æœ¨æ–¯ã€å…‹æ‹‰çŽ›ä¾ã€å‘¼ä¼¦è´å°”ã€è´ºå·žã€é€šåŒ–ã€é˜³æ³‰ã€æœé˜³ã€ç™¾è‰²ã€æ¯•èŠ‚ã€è´µæ¸¯ã€ä¸½æ±Ÿã€å®‰åº·ã€é€šè¾½ã€å¾·å®ã€æœ”å·žã€ä¼ŠçŠã€æ–‡å±±ã€æ¥šé›„ã€å˜‰å³ªå…³ã€å‡‰å±±ã€èµ„é˜³ã€é”¡æž—éƒ­å‹’ç›Ÿã€é›…å®‰'
        .split('ã€')
        .map((item) => {
          return { name: item, type: 'fiveLine' };
        });
// , twoLine, threeLine, fourLine, fiveLine
    const cities = [].concat(oneLine);
    // const cities = [].concat(fiveLine);

    const addresses = [];
    for (let i = 0; i < keyworkds.length; i++) {
      for (let j = 0; j < cities.length; j++) {
        const keyword = keyworkds[i];
        console.log(
          `${i + 1}/${keyworkds.length}  ðŸš€ ~ keyword: ${keyword} ðŸš€ ~ city${
            j + 1
          }/${cities.length}:    ${cities[j].name}`,
        );

        const city = cities[j];
        // const keywordstr = `${keyword} ${city.name}`;
        const targetHost = `https://www.amap.com`;
        const items = (await clollectBusinessDistrict(
          targetHost,
          keyword,
          city.name,
        )) as any;
        try {
          let prefix = '';
          if (j !== 0) {
            prefix = ',';
          } else {
            appendFileSync(`businessDistricts/${city.type}.json`, '[');
          }
          appendFileSync(
            `businessDistricts/${city.type}.json`,
            prefix + JSON.stringify({ items, keyword, city }),
          );

          if (j + 1 === cities.length) {
            appendFileSync(`${keyword}.json`, ']');
          }
        } catch (error) {
          console.error('ä¿å­˜å¤±è´¥');
        }
      }
    }

    // é€šçŸ¥çŸ¥éŸ³æ¥¼å¼€å§‹çˆ¬å–æ•°æ®
    try {
      // æŽ’é™¤å¹¿å‘Š éžç¬”è®°ç±»åž‹æ•°æ®
    } catch (error) {
      console.error(error);
    }
    return 'æœç´¢æ•°æ®ç»“æŸ';
  }
}
